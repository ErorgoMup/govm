name: Build and publish release

# 提取可配置变量
env:
  GO_VERSION: "1.22.5"
  BINARY_NAME: "govm"
  MODULE_PATH: "github.com/Open-Source-CQUT/govm/cmd/govm"

on:
  push:
    tags:
      - 'v*'  # 仅在推送 v 开头标签时触发
  workflow_dispatch:
    inputs:
      tag:
        description: 'Tag to create release for (e.g., v1.0.0)'
        required: true
        default: 'v1.0.0'

permissions:
  contents: write

jobs:
  create_release:
    name: Create release
    runs-on: ubuntu-latest
    outputs:
      upload_url: ${{ steps.create_release.outputs.upload_url }}
      release_tag: ${{ steps.get_tag.outputs.tag }}
    steps:
      - name: Get release tag
        id: get_tag
        run: |
          if [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
            TAG="${{ github.event.inputs.tag }}"
          else
            TAG="${{ github.ref_name }}"
          fi
          # 确保标签以 v 开头
          if [[ ! $TAG =~ ^v ]]; then
            TAG="v$TAG"
          fi
          echo "tag=$TAG" >> $GITHUB_OUTPUT
          echo "version=${TAG#v}" >> $GITHUB_OUTPUT

      - name: Create GitHub release
        id: create_release
        uses: actions/create-release@v1
        with:
          tag_name: ${{ steps.get_tag.outputs.tag }}
          release_name: ${{ steps.get_tag.outputs.tag }}
          body: |
            ## govm ${{ steps.get_tag.outputs.tag }}
            Automated build for govm (Go version manager)
            
            ### What's new
            - Automated release build for ${{ steps.get_tag.outputs.tag }}
            - Support Windows/Linux/macOS (386/amd64/arm/arm64)
            - Built with Go ${{ env.GO_VERSION }}
            
            ### Installation
            See [installation guide](https://github.com/Open-Source-CQUT/govm#installation) for details.
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.TOKEN }}

  build_and_upload:
    name: Build ${{ matrix.os }}/${{ matrix.arch }}
    needs: create_release
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        os: [windows, linux, darwin]
        arch: [386, amd64, arm, arm64]
        exclude:
          # Darwin 不支持 386 和 arm 架构
          - os: darwin
            arch: 386
          - os: darwin
            arch: arm

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # 获取完整git历史以获取tag信息

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: ${{ env.GO_VERSION }}
          cache: true  # 启用Go模块缓存

      - name: Install build dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y zip unzip make

      - name: Build with Makefile
        id: build
        run: |
          set -e
          TAG="${{ needs.create_release.outputs.release_tag }}"
          VERSION="${TAG#v}"
          
          # 使用make构建指定平台
          make build \
            mode=release \
            os=${{ matrix.os }} \
            arch=${{ matrix.arch }}
          
          # 确定二进制文件路径
          BIN_DIR="./bin/release/${{ env.BINARY_NAME }}-${{ matrix.os }}-${{ matrix.arch }}"
          if [[ "${{ matrix.os }}" == "windows" ]]; then
            BIN_PATH="${BIN_DIR}/${{ env.BINARY_NAME }}.exe"
            PACKAGE_NAME="${{ env.BINARY_NAME }}_${VERSION}_${{ matrix.os }}_${{ matrix.arch }}.zip"
            # 打包为zip
            (cd $BIN_DIR && zip -j "$PACKAGE_NAME" "${{ env.BINARY_NAME }}.exe")
            PACKAGE_PATH="${BIN_DIR}/${PACKAGE_NAME}"
          else
            BIN_PATH="${BIN_DIR}/${{ env.BINARY_NAME }}"
            PACKAGE_NAME="${{ env.BINARY_NAME }}_${VERSION}_${{ matrix.os }}_${{ matrix.arch }}.tar.gz"
            # 打包为tar.gz
            tar -C $BIN_DIR -czf "${BIN_DIR}/${PACKAGE_NAME}" "${{ env.BINARY_NAME }}"
            PACKAGE_PATH="${BIN_DIR}/${PACKAGE_NAME}"
          fi
          
          # 输出必要信息
          echo "PACKAGE_PATH=$PACKAGE_PATH" >> $GITHUB_OUTPUT
          echo "PACKAGE_NAME=$PACKAGE_NAME" >> $GITHUB_OUTPUT
          
          # 验证文件存在
          if [[ ! -f "$PACKAGE_PATH" ]]; then
            echo "Error: Package $PACKAGE_PATH not found!"
            exit 1
          fi
          
          # 输出文件信息
          ls -lh $PACKAGE_PATH

      - name: Upload release asset
        uses: actions/upload-release-asset@v1
        with:
          upload_url: ${{ needs.create_release.outputs.upload_url }}
          asset_path: ${{ steps.build.outputs.PACKAGE_PATH }}
          asset_name: ${{ steps.build.outputs.PACKAGE_NAME }}
          asset_content_type: application/octet-stream
        env:
          GITHUB_TOKEN: ${{ secrets.TOKEN }}

  verify_release:
    name: Verify release assets
    needs: [create_release, build_and_upload]
    runs-on: ubuntu-latest
    steps:
      - name: Check release assets
        run: |
          set -e
          TAG="${{ needs.create_release.outputs.release_tag }}"
          REPO="Open-Source-CQUT/govm"
          
          # 列出发布资产（仅验证）
          echo "Verifying release assets for $TAG..."
          gh release view $TAG --repo $REPO --json assets --jq '.assets[].name'
          
          # 检查关键资产是否存在
          ASSETS=(
            "govm_${TAG#v}_linux_amd64.tar.gz"
            "govm_${TAG#v}_windows_amd64.zip"
            "govm_${TAG#v}_darwin_amd64.tar.gz"
          )
          
          for ASSET in "${ASSETS[@]}"; do
            if ! gh release view $TAG --repo $REPO --json assets --jq ".assets[] | select(.name == \"$ASSET\")" > /dev/null; then
              echo "Error: Missing required asset $ASSET"
              exit 1
            fi
            echo "✓ Found asset: $ASSET"
          done
        env:
          GITHUB_TOKEN: ${{ secrets.TOKEN }}